<Window x:Class="NavegadorWeb.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:NavegadorWeb"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        mc:Ignorable="d"
        Title="Aurora Browser" Height="768" Width="1024"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Loaded="Window_Loaded"
        Closing="Window_Closing"
        SourceInitialized="MainWindow_SourceInitialized"
        StateChanged="MainWindow_StateChanged">

    <Window.Resources>
        <!-- Colores por defecto para el navegador -->
        <Color x:Key="DefaultBrowserBackgroundColor">#282c34</Color> <!-- Gris oscuro/azulado -->
        <SolidColorBrush x:Key="DefaultBrowserBackgroundBrush" Color="{StaticResource DefaultBrowserBackgroundColor}"/>

        <Color x:Key="DefaultBrowserForegroundColor">#abb2bf</Color> <!-- Texto claro -->
        <SolidColorBrush x:Key="DefaultBrowserForegroundBrush" Color="{StaticResource DefaultBrowserForegroundColor}"/>

        <!-- Colores para el modo Gemini -->
        <Color x:Key="GeminiBackgroundColor">#343a40</Color> <!-- Un gris m√°s oscuro para Gemini -->
        <SolidColorBrush x:Key="GeminiBackgroundBrush" Color="{StaticResource GeminiBackgroundColor}"/>

        <Color x:Key="GeminiForegroundColor">#61afef</Color> <!-- Azul vibrante para Gemini -->
        <SolidColorBrush x:Key="GeminiForegroundBrush" Color="{StaticResource GeminiForegroundColor}"/>

        <!-- Colores din√°micos que se pueden cambiar en tiempo de ejecuci√≥n -->
        <Color x:Key="BrowserBackgroundColor" x:Shared="False">#282c34</Color>
        <SolidColorBrush x:Key="BrowserBackgroundBrush" x:Shared="False" Color="{DynamicResource BrowserBackgroundColor}"/>

        <Color x:Key="BrowserForegroundColor" x:Shared="False">#abb2bf</Color>
        <SolidColorBrush x:Key="BrowserForegroundBrush" x:Shared="False" Color="{DynamicResource BrowserForegroundColor}"/>

        <!-- Convertidor de booleano a visibilidad -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Estilo base para todos los botones -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource BrowserForegroundColor}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#3a3e47"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#1f2227"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Estilo para los botones de control de ventana (Minimizar, Maximizar, Cerrar) -->
        <Style x:Key="WindowControlButton" TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
            <Setter Property="Width" Value="30"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="Foreground" Value="{DynamicResource BrowserForegroundColor}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#444a54"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#1f2227"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="WindowCloseButton" TargetType="Button" BasedOn="{StaticResource WindowControlButton}">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E74C3C"/> <!-- Rojo para el bot√≥n de cerrar al pasar el rat√≥n -->
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#C0392B"/> <!-- Rojo m√°s oscuro al presionar -->
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Estilo para TextBox -->
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="#1a1a1a"/>
            <Setter Property="Foreground" Value="{DynamicResource BrowserForegroundColor}"/>
            <Setter Property="BorderBrush" Value="#333333"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="CaretBrush" Value="{DynamicResource BrowserForegroundColor}"/>
        </Style>

        <!-- Estilo para TabItem -->
        <Style x:Key="TabItemStyle" TargetType="TabItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Grid>
                            <Border Name="Border"
                                    Margin="0,0,2,0"
                                    Background="{DynamicResource BrowserBackgroundBrush}"
                                    BorderBrush="{DynamicResource BrowserBackgroundBrush}"
                                    BorderThickness="1,1,1,0"
                                    CornerRadius="5,5,0,0">
                                <ContentPresenter x:Name="ContentSite"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Center"
                                        ContentSource="Header"
                                        Margin="12,2,12,2"/>
                            </Border>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource BrowserBackgroundColor}"/>
                                <Setter TargetName="Border" Property="BorderBrush" Value="{DynamicResource BrowserForegroundColor}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#444a54"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Estilo para ToggleButton con apariencia de Switch -->
        <Style x:Key="SwitchToggleButton" TargetType="ToggleButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid VerticalAlignment="Center" HorizontalAlignment="Left">
                            <Border x:Name="OuterBorder"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="10"
                                    Width="40"
                                    Height="20"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="1"/>
                            <Ellipse x:Name="ToggleThumb"
                                     Fill="{TemplateBinding Foreground}"
                                     Width="16"
                                     Height="16"
                                     HorizontalAlignment="Left"
                                     Margin="2,0,0,0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="OuterBorder" Property="Background" Value="#28a745"/>
                                <Setter TargetName="ToggleThumb" Property="HorizontalAlignment" Value="Right"/>
                                <Setter TargetName="ToggleThumb" Property="Margin" Value="0,0,2,0"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="False">
                                <Setter TargetName="OuterBorder" Property="Background" Value="#dc3545"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Estilo para ListBoxItem sin selecci√≥n de fondo azul -->
        <Style TargetType="ListBoxItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ListBoxItem}">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="true">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#3a3e47"/>
                                <Setter Property="Foreground" Value="{DynamicResource BrowserForegroundColor}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#444a54"/>
                                <Setter Property="Foreground" Value="{DynamicResource BrowserForegroundColor}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{DynamicResource BrowserForegroundColor}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ContextMenu para la barra de direcciones (definido como recurso) -->
        <ContextMenu x:Key="AddressBarContextMenu">
            <MenuItem Header="Cortar" Command="ApplicationCommands.Cut"/>
            <MenuItem Header="Copiar" Command="ApplicationCommands.Copy"/>
            <MenuItem Header="Pegar" Command="ApplicationCommands.Paste"/>
        </ContextMenu>

        <!-- DataTemplate para la cabecera de la pesta√±a -->
        <DataTemplate x:Key="TabHeaderTemplate">
            <StackPanel Orientation="Horizontal">
                <Image Source="{Binding Favicon}" Width="16" Height="16" Margin="0,0,5,0"/>
                <TextBlock Text="{Binding Title}" ToolTip="{Binding Url}" VerticalAlignment="Center"/>
                <Button Content="‚úï" Click="CloseTabButton_Click"
                        Margin="5,0,0,0"
                        Width="20" Height="20"
                        Style="{StaticResource {x:Type Button}}"
                        Background="Transparent" Foreground="White"
                        BorderThickness="0" Padding="0"
                        Tag="{Binding}"/> <!-- Usar Tag para pasar el TabItemData -->
            </StackPanel>
        </DataTemplate>

        <!-- Estilo personalizado para la barra de desplazamiento (para WebView2) -->
        <Style x:Key="CustomScrollBarStyle" TargetType="{x:Type ScrollViewer}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollViewer}">
                        <Grid SnapsToDevicePixels="True" Background="{TemplateBinding Background}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <ScrollContentPresenter CanContentScroll="{TemplateBinding CanContentScroll}"
                                                    CanHorizontallyScroll="False"
                                                    CanVerticallyScroll="False"
                                                    ContentTemplate="{TemplateBinding ContentTemplate}"
                                                    Content="{TemplateBinding Content}"
                                                    Grid.Column="0" Grid.Row="0"/>
                            <ScrollBar x:Name="PART_VerticalScrollBar"
                                       AutomationProperties.AutomationId="VerticalScrollBar"
                                       Cursor="Arrow"
                                       Grid.Column="1" Grid.Row="0"
                                       Maximum="{TemplateBinding ScrollableHeight}"
                                       Orientation="Vertical"
                                       ViewportSize="{TemplateBinding ViewportHeight}"
                                       Value="{TemplateBinding VerticalOffset}"
                                       Visibility="{TemplateBinding ComputedVerticalScrollBarVisibility}">
                                <ScrollBar.Template>
                                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                                        <Grid x:Name="Bg" SnapsToDevicePixels="True" Background="{DynamicResource BrowserBackgroundColor}">
                                            <Track x:Name="PART_Track" IsDirectionReversed="True" IsEnabled="{TemplateBinding IsMouseOver}" Margin="0,2,0,2">
                                                <Track.DecreaseRepeatButton>
                                                    <RepeatButton Command="{x:Static ScrollBar.PageUpCommand}" Opacity="0"/>
                                                </Track.DecreaseRepeatButton>
                                                <Track.Thumb>
                                                    <Thumb Background="{DynamicResource BrowserForegroundColor}" Style="{StaticResource ScrollBarThumbStyle}"/>
                                                </Track.Thumb>
                                                <Track.IncreaseRepeatButton>
                                                    <RepeatButton Command="{x:Static ScrollBar.PageDownCommand}" Opacity="0"/>
                                                </Track.IncreaseRepeatButton>
                                            </Track>
                                        </Grid>
                                    </ControlTemplate>
                                </ScrollBar.Template>
                            </ScrollBar>
                            <ScrollBar x:Name="PART_HorizontalScrollBar"
                                       AutomationProperties.AutomationId="HorizontalScrollBar"
                                       Cursor="Arrow"
                                       Grid.Column="0" Grid.Row="1"
                                       Maximum="{TemplateBinding ScrollableWidth}"
                                       Orientation="Horizontal"
                                       ViewportSize="{TemplateBinding ViewportWidth}"
                                       Value="{TemplateBinding HorizontalOffset}"
                                       Visibility="{TemplateBinding ComputedHorizontalScrollBarVisibility}">
                                <ScrollBar.Template>
                                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                                        <Grid x:Name="Bg" SnapsToDevicePixels="True" Background="{DynamicResource BrowserBackgroundColor}">
                                            <Track x:Name="PART_Track" IsEnabled="{TemplateBinding IsMouseOver}" Margin="2,0,2,0">
                                                <Track.DecreaseRepeatButton>
                                                    <RepeatButton Command="{x:Static ScrollBar.PageLeftCommand}" Opacity="0"/>
                                                </Track.DecreaseRepeatButton>
                                                <Track.Thumb>
                                                    <Thumb Background="{DynamicResource BrowserForegroundColor}" Style="{StaticResource ScrollBarThumbStyle}"/>
                                                </Track.Thumb>
                                                <Track.IncreaseRepeatButton>
                                                    <RepeatButton Command="{x:Static ScrollBar.PageRightCommand}" Opacity="0"/>
                                                </RepeatButton>
                                            </Track>
                                        </Grid>
                                    </ControlTemplate>
                                </ScrollBar.Template>
                            </ScrollBar>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ScrollBarThumbStyle" TargetType="{x:Type Thumb}">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Height" Value="10"/>
            <Setter Property="Width" Value="10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Thumb}">
                        <Border Background="{TemplateBinding Background}" CornerRadius="5"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <!-- Borde principal para aplicar CornerRadius a toda la ventana -->
    <Border x:Name="MainBorder"
            Background="{DynamicResource BrowserBackgroundBrush}"
            CornerRadius="10"
            BorderBrush="{DynamicResource BrowserForegroundColor}"
            BorderThickness="1">
        <Grid x:Name="mainGrid" >
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Barra de t√≠tulo personalizada -->
                <RowDefinition Height="Auto"/> <!-- Barra de navegaci√≥n (URL, botones) -->
                <RowDefinition Height="Auto"/> <!-- Barra de b√∫squeda (find) -->
                <RowDefinition Height="*"/>    <!-- Contenido principal del navegador (WebView2) -->
                <RowDefinition Height="Auto"/> <!-- Barra de progreso de descarga -->
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Barra de t√≠tulo personalizada -->
            <Grid Grid.Row="0" x:Name="TitleBarGrid"
                  Background="{DynamicResource BrowserBackgroundBrush}"
                  MouseLeftButtonDown="Window_MouseLeftButtonDown">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Image Source="icono.ico" Width="16" Height="16" Margin="5,0,0,0" VerticalAlignment="Center" Grid.Column="0"/>
                <TextBlock x:Name="WindowTitleText"
                           Text="Aurora Browser"
                           Grid.Column="1"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Left"
                           Margin="5,0,0,0"
                           Foreground="{DynamicResource BrowserForegroundColor}"
                           FontWeight="Bold"/>

                <!-- Botones de control de ventana -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Grid.Column="4">
                    <Button x:Name="MinimizeButton" Content="‚Äî" Click="MinimizeButton_Click"
                            ToolTip="Minimizar" Style="{StaticResource WindowControlButton}"/>
                    <Button x:Name="MaximizeRestoreButton" Content="üóñ" Click="MaximizeRestoreButton_Click"
                            ToolTip="Maximizar / Restaurar" Style="{StaticResource WindowControlButton}"/>
                    <Button x:Name="CloseButton" Content="‚úï" Click="CloseButton_Click"
                            ToolTip="Cerrar" Style="{StaticResource WindowCloseButton}"/>
                </StackPanel>
            </Grid>

            <!-- Barra de navegaci√≥n (URL, botones) -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="5" x:Name="ToolbarGrid">
                <Button Command="{x:Static NavigationCommands.BrowseBack}" ToolTip="Atr√°s" Margin="0,0,5,0" x:Name="GoBackButton"/>
                <Button Command="{x:Static NavigationCommands.BrowseForward}" ToolTip="Adelante" Margin="0,0,5,0" x:Name="GoForwardButton"/>
                <Button Command="{x:Static NavigationCommands.Refresh}" ToolTip="Recargar" Margin="0,0,5,0"/>
                <Button Command="{x:Static NavigationCommands.GoToPage}" ToolTip="Inicio" Margin="0,0,5,0"/>

                <TextBox x:Name="AddressBar"
                         Text="{Binding SelectedTabItem.Url, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         KeyDown="AddressBar_KeyDown"
                         VerticalContentAlignment="Center"
                         HorizontalAlignment="Stretch"
                         Margin="5,0"
                         ContextMenu="{StaticResource AddressBarContextMenu}"
                         TextWrapping="Wrap"
                         AcceptsReturn="False"
                         ScrollViewer.CanContentScroll="True"
                         VerticalScrollBarVisibility="Auto"
                         HorizontalScrollBarVisibility="Auto">
                    <TextBox.Style>
                        <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                            <Setter Property="Width" Value="*"/> <!-- Para que ocupe el espacio restante -->
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=StackPanel}, Path=Orientation}" Value="Horizontal">
                                    <Setter Property="Width" Value="*"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>
                <Button Command="{x:Static NavigationCommands.Search}" ToolTip="Ir" Margin="5,0,0,0"/>

                <!-- Botones de la barra de herramientas -->
                <Button x:Name="FindButton" Click="FindButton_Click" ToolTip="Buscar en la p√°gina" Margin="5,0,0,0">
                    <Image Source="/Resources/find.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="GeminiButton" Click="GeminiButton_Click" ToolTip="Preguntar a Gemini" Margin="5,0,0,0">
                    <Image Source="/Resources/ai.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="PipButton" Click="PipButton_Click" ToolTip="Picture-in-Picture" Margin="5,0,0,0">
                    <Image Source="/Resources/pip.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="ReadAloudButton" Click="ReadAloudButton_Click" ToolTip="Leer en voz alta" Margin="5,0,0,0">
                    <Image Source="/Resources/read_aloud.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="ReaderModeButton" Click="ReaderModeButton_Click" ToolTip="Modo lector" Margin="5,0,0,0">
                    <Image Source="/Resources/reader.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="IncognitoButton" Click="IncognitoButton_Click" ToolTip="Modo Inc√≥gnito" Margin="5,0,0,0">
                    <Image Source="/Resources/incognito.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="HistoryButton" Click="HistoryButton_Click" ToolTip="Historial" Margin="5,0,0,0">
                    <Image Source="/Resources/history.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="BookmarksButton" Click="BookmarksButton_Click" ToolTip="Favoritos" Margin="5,0,0,0">
                    <Image Source="/Resources/bookmarks.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="PasswordManagerButton" Click="PasswordManagerButton_Click" ToolTip="Contrase√±as" Margin="5,0,0,0">
                    <Image Source="/Resources/password.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="DataExtractionButton" Click="DataExtractionButton_Click" ToolTip="Extracci√≥n de Datos" Margin="5,0,0,0">
                    <Image Source="/Resources/data_extraction.png" Width="20" Height="20"/>
                </Button>
                <Button x:Name="ExtensionsButton" ToolTip="Extensiones" Margin="5,0,0,0" >
                    <Button.Content>
                        <Image Source="/Resources/extensions.png" Width="20" Height="20"/>
                    </Button.Content>
                    <Button.ContextMenu>
                        <ContextMenu x:Name="ExtensionsMenuItem" ItemsSource="{Binding ExtensionManager.Extensions}">
                            <ContextMenu.ItemTemplate>
                                <DataTemplate>
                                    <MenuItem Header="{Binding Name}" IsCheckable="True" IsChecked="{Binding IsEnabled}" Click="ExtensionMenuItem_Click" Tag="{Binding}"/>
                                </DataTemplate>
                            </ContextMenu.ItemTemplate>
                            <MenuItem Header="Administrar Extensiones..." Click="ManageExtensionsButton_Click"/>
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
                <Button x:Name="SettingsButton" Click="SettingsButton_Click" ToolTip="Configuraci√≥n" Margin="5,0,0,0">
                    <Image Source="/Resources/settings.png" Width="20" Height="20"/>
                </Button>
            </StackPanel>

            <!-- Barra de b√∫squeda (Find Bar) -->
            <Border x:Name="FindBar"
                    Grid.Row="2"
                    Visibility="{Binding IsFindBarVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Background="{DynamicResource BrowserBackgroundBrush}"
                    BorderBrush="{DynamicResource BrowserForegroundColor}"
                    BorderThickness="0,1,0,1"
                    Margin="0,0,0,5"
                    Padding="5">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <TextBlock Text="Buscar:" VerticalAlignment="Center" Margin="0,0,5,0"
                               Foreground="{DynamicResource BrowserForegroundColor}"/>
                    <TextBox x:Name="FindTextBox"
                             Width="200"
                             VerticalContentAlignment="Center"
                             KeyDown="FindTextBox_KeyDown"
                             TextChanged="FindTextBox_TextChanged"
                             Margin="0,0,5,0"/>
                    <TextBlock x:Name="FindResultsTextBlock"
                               VerticalAlignment="Center"
                               Margin="0,0,10,0"
                               Foreground="{DynamicResource BrowserForegroundColor}"/>
                    <Button Content="‚ñ≤"
                            Click="FindPreviousButton_Click"
                            Margin="0,0,2,0"
                            ToolTip="Buscar anterior"/>
                    <Button Content="‚ñº"
                            Click="FindNextButton_Click"
                            Margin="0,0,5,0"
                            ToolTip="Buscar siguiente"/>
                    <Button Content="‚úñ"
                            Click="CloseFindBarButton_Click"
                            ToolTip="Cerrar b√∫squeda"/>
                </StackPanel>
            </Border>

            <!-- Contenido Principal del Navegador (Pesta√±as) -->
            <TabControl x:Name="BrowserTabs"
                        Grid.Row="3" Grid.Column="0"
                        ItemsSource="{Binding TabGroupManager.SelectedTabGroup.TabsInGroup}"
                        SelectedItem="{Binding SelectedTabItem, Mode=TwoWay}"
                        SelectionChanged="BrowserTabControl_SelectionChanged_Grouped"
                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                        ItemTemplate="{StaticResource TabHeaderTemplate}">
            </TabControl>

            <!-- Barra de progreso de descarga -->
            <ProgressBar Grid.Row="4"
                         Height="5"
                         Value="{Binding DownloadProgress}"
                         Visibility="{Binding DownloadProgressBarVisibility}"
                         Background="#333" Foreground="#007bff"
                         BorderThickness="0"
                         Margin="0,0,0,0"
                         VerticalAlignment="Bottom"/>
        </Grid>
    </Border>
</Window>
```

---

### 2. `GeminiDataViewerWindow.xaml` - C√≥digo Corregido

Aqu√≠ he envuelto el `Grid` principal con un `Border` para poder aplicar `CornerRadius` correctamente, y he ajustado las propiedades de `Background` y `BorderThickness` en el `Border` para que coincidan con el dise√±o.


```xml
<Window x:Class="NavegadorWeb.GeminiDataViewerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:NavegadorWeb"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        mc:Ignorable="d"
        Title="Datos para Gemini" Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        AllowsTransparency="True"
        WindowStyle="None"
        Background="Transparent">
    <Border Background="#F0F0F0" CornerRadius="10" BorderBrush="#CCCCCC" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Informaci√≥n Capturada para Gemini" FontSize="20" FontWeight="Bold" Margin="10" HorizontalAlignment="Center" Foreground="#333"/>

            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,10">
                <TextBlock Text="Pregunta del Usuario:" FontWeight="SemiBold" Margin="0,0,5,0" VerticalAlignment="Center"/>
                <TextBox x:Name="UserQuestionTextBox"
                         Width="400" Height="30" Padding="5"
                         Text="{Binding UserQuestion, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         VerticalContentAlignment="Center"
                         BorderBrush="#ccc" BorderThickness="1" CornerRadius="3"
                         Background="White"/>
            </StackPanel>

            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="10,0">
                <StackPanel x:Name="CapturedDataPanel" Orientation="Vertical"
                            DataContext="{Binding}"
                            Background="White"
                            Padding="10"
                            BorderBrush="#ddd" BorderThickness="1" CornerRadius="5">
                    <ItemsControl ItemsSource="{Binding CapturedData}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="5" Margin="0,5,0,5" Padding="10" Background="#F8F8F8">
                                    <StackPanel>
                                        <TextBlock Text="URL:" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding Url}" TextWrapping="Wrap" Margin="0,0,0,5" Foreground="#555"/>
                                        <TextBlock Text="T√≠tulo:" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding Title}" TextWrapping="Wrap" Margin="0,0,0,5" Foreground="#555"/>
                                        <TextBlock Text="Texto Extra√≠do:" FontWeight="Bold" Margin="0,5,0,0"/>
                                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="100">
                                            <TextBlock Text="{Binding ExtractedText}" TextWrapping="Wrap" Margin="0,0,0,5"/>
                                        </ScrollViewer>
                                        <TextBlock Text="Captura de Pantalla:" FontWeight="Bold" Margin="0,5,0,0"/>
                                        <Image Source="{Binding ScreenshotBase64}" MaxHeight="200" Stretch="Uniform" Margin="0,0,0,5"/>
                                        <TextBlock Text="Favicon:" FontWeight="Bold" Margin="0,5,0,0"/>
                                        <Image Source="{Binding FaviconBase64}" Width="24" Height="24" HorizontalAlignment="Left"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>

            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
                <Button x:Name="SendToGeminiButton" Content="Enviar a Gemini" Padding="10,5" Margin="0,0,10,0" Background="#9B59B6" Foreground="White" FontWeight="Bold" BorderBrush="#8E44AD" BorderThickness="1" Click="SendToGeminiButton_Click"/>
                <Button x:Name="CancelButton" Content="Cancelar" Padding="10,5" Background="#E74C3C" Foreground="White" FontWeight="Bold" BorderBrush="#C0392B" BorderThickness="1" Click="CancelButton_Click"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
```

---

### 3. `MainWindow.xaml.cs` - C√≥digo Corregido (Con captura de pantalla)

He re-habilitado la l√≥gica de captura de pantalla y favicon, y he ajustado la forma en que se obtienen los datos para Gemini. Tambi√©n he a√±adido el manejo de la barra de progreso de descarga.


```csharp
using Microsoft.Web.WebView2.Core; // ¬°Esta l√≠nea es CRUCIAL y debe estar al inicio!
using Microsoft.Web.WebView2.Wpf;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.IO;
using System.Text.Json;
using System.Speech.Synthesis;
using System.Windows.Media.Imaging;
using System.Windows.Media;
using System.Diagnostics; // Necesario para Process.Start
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.ComponentModel;
using System.Windows.Interop;
using System.Runtime.InteropServices;
using System.Net.NetworkInformation;
using System.Timers;

namespace NavegadorWeb
{
    // La clase partial MainWindow ya es generada por el compilador para incluir los elementos XAML.
    public partial class MainWindow : Window, INotifyPropertyChanged
    {
        private string _defaultHomePage = "https://www.google.com";
        private const string HomePageSettingKey = "DefaultHomePage";
        private const string AdBlockerSettingKey = "AdBlockerEnabled";
        private const string DefaultSearchEngineSettingKey = "DefaultSearchEngine";
        private const string TabSuspensionSettingKey = "TabSuspensionEnabled";
        private const string RestoreSessionSettingKey = "RestoreSessionOnStartup";
        private const string LastSessionUrlsSettingKey = "LastSessionUrls";
        private const string LastSessionTabGroupsSettingKey = "LastSessionTabGroups"; // Nueva clave
        private const string LastSelectedTabGroupSettingKey = "LastSelectedTabGroup"; // Nueva clave

        private bool _isAdBlockerEnabled;
        public bool IsAdBlockerEnabled
        {
            get => _isAdBlockerEnabled;
            set
            {
                if (_isAdBlockerEnabled != value)
                {
                    _isAdBlockerEnabled = value;
                    OnPropertyChanged(nameof(IsAdBlockerEnabled));
                    ApplyAdBlockerSettings();
                }
            }
        }

        private bool _isGeminiModeActive;
        public bool IsGeminiModeActive
        {
            get => _isGeminiModeActive;
            set
            {
                if (_isGeminiModeActive != value)
                {
                    _isGeminiModeActive = value;
                    OnPropertyChanged(nameof(IsGeminiModeActive));
                    ApplyTheme(); // Cambia el tema al activar/desactivar el modo Gemini
                }
            }
        }

        private bool _isFindBarVisible;
        public bool IsFindBarVisible
        {
            get => _isFindBarVisible;
            set
            {
                if (_isFindBarVisible != value)
                {
                    _isFindBarVisible = value;
                    OnPropertyChanged(nameof(IsFindBarVisible));
                }
            }
        }

        private string _findSearchText = "";
        public string FindSearchText
        {
            get => _findSearchText;
            set
            {
                if (_findSearchText != value)
                {
                    _findSearchText = value;
                    OnPropertyChanged(nameof(FindSearchText));
                    FindInPage(_findSearchText);
                }
            }
        }

        private string _findResultsText = "";
        public string FindResultsText
        {
            get => _findResultsText;
            set
            {
                if (_findResultsText != value)
                {
                    _findResultsText = value;
                    OnPropertyChanged(nameof(FindResultsText));
                }
            }
        }

        private TabItemData? _selectedTabItem;
        public TabItemData? SelectedTabItem
        {
            get => _selectedTabItem;
            set
            {
                if (_selectedTabItem != value)
                {
                    _selectedTabItem = value;
                    OnPropertyChanged(nameof(SelectedTabItem));
                    UpdateBrowserControls();
                }
            }
        }

        // Propiedades para la barra de progreso
        private double _downloadProgress;
        public double DownloadProgress
        {
            get => _downloadProgress;
            set
            {
                _downloadProgress = value;
                OnPropertyChanged(nameof(DownloadProgress));
            }
        }

        private Visibility _downloadProgressBarVisibility = Visibility.Collapsed;
        public Visibility DownloadProgressBarVisibility
        {
            get => _downloadProgressBarVisibility;
            set
            {
                _downloadProgressBarVisibility = value;
                OnPropertyChanged(nameof(DownloadProgressBarVisibility));
            }
        }

        public TabGroupManager TabGroupManager { get; private set; }
        public ExtensionManager ExtensionManager { get; private set; } // A√±adir ExtensionManager

        // Speech Synthesizer para Read Aloud
        private SpeechSynthesizer? _speechSynthesizer;
        private bool _isReadingAloud = false;

        // Propiedad para almacenar los datos capturados para Gemini
        public ObservableCollection<CapturedPageData> CapturedPagesForGemini { get; set; } = new ObservableCollection<CapturedPageData>();


        // Implementaci√≥n expl√≠cita del evento PropertyChanged para INotifyPropertyChanged
        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }

        // Constantes para el tama√±o m√≠nimo de la ventana
        private const double MIN_WIDTH = 800;
        private const double MIN_HEIGHT = 600;

        // Timer para la suspensi√≥n de pesta√±as
        private System.Timers.Timer _tabSuspensionTimer;
        private TimeSpan _tabSuspensionDelay = TimeSpan.FromMinutes(5); // 5 minutos de inactividad
        private bool _isTabSuspensionEnabled;
        public bool IsTabSuspensionEnabled
        {
            get => _isTabSuspensionEnabled;
            set
            {
                if (_isTabSuspensionEnabled != value)
                {
                    _isTabSuspensionEnabled = value;
                    OnPropertyChanged(nameof(IsTabSuspensionEnabled));
                    if (_isTabSuspensionEnabled)
                    {
                        StartTabSuspensionTimer();
                    }
                    else
                    {
                        StopTabSuspensionTimer();
                    }
                }
            }
        }


        public MainWindow()
        {
            InitializeComponent();
            this.DataContext = this; // Establecer el DataContext a la propia ventana

            TabGroupManager = new TabGroupManager();
            ExtensionManager = new ExtensionManager(); // Inicializar ExtensionManager

            LoadSettings(); // Cargar configuraciones al inicio
            ApplyAdBlockerSettings(); // Aplicar el estado inicial del AdBlocker
            ApplyTheme(); // Aplicar el tema inicial

            // Inicializar el sintetizador de voz
            _speechSynthesizer = new SpeechSynthesizer();
            _speechSynthesizer.SetOutputToDefaultAudioDevice();

            // Configurar el temporizador de suspensi√≥n de pesta√±as
            _tabSuspensionTimer = new System.Timers.Timer(_tabSuspensionDelay.TotalMilliseconds);
            _tabSuspensionTimer.Elapsed += TabSuspensionTimer_Elapsed;
            _tabSuspensionTimer.AutoReset = true; // Para que se repita
            if (IsTabSuspensionEnabled)
            {
                StartTabSuspensionTimer();
            }

            // Vincular el evento PreviewMouseMove para reiniciar el temporizador
            this.PreviewMouseMove += MainWindow_UserActivity;
            this.PreviewKeyDown += MainWindow_UserActivity;
        }


        // M√©todos para la suspensi√≥n de pesta√±as
        private void StartTabSuspensionTimer()
        {
            _tabSuspensionTimer.Start();
        }

        private void StopTabSuspensionTimer()
        {
            _tabSuspensionTimer.Stop();
        }

        private void MainWindow_UserActivity(object sender, EventArgs e)
        {
            // Reiniciar el temporizador de inactividad en cada actividad del usuario
            if (IsTabSuspensionEnabled)
            {
                _tabSuspensionTimer.Stop();
                _tabSuspensionTimer.Start();
            }
        }

        private async void TabSuspensionTimer_Elapsed(object? sender, ElapsedEventArgs e)
        {
            // Este m√©todo se ejecuta en un hilo diferente, as√≠ que necesitamos usar el Dispatcher
            await Dispatcher.InvokeAsync(async () =>
            {
                foreach (var group in TabGroupManager.TabGroups)
                {
                    foreach (var tab in group.TabsInGroup)
                    {
                        if (tab != SelectedTabItem && tab.WebViewInstance != null && tab.WebViewInstance.CoreWebView2 != null)
                        {
                            // Suspender la pesta√±a
                            tab.IsSuspended = true;
                            tab.LastSuspendedUrl = tab.WebViewInstance.Source.ToString(); // Guardar la URL actual
                            tab.WebViewInstance.CoreWebView2.Stop(); // Detener la carga
                            tab.WebViewInstance.Source = new Uri("about:blank"); // Cargar una p√°gina en blanco
                            Console.WriteLine($"Pesta√±a suspendida: {tab.Title}");
                        }
                    }
                }
            });
        }

        public async void ActivateTab(TabItemData tab)
        {
            if (tab.IsSuspended)
            {
                tab.IsSuspended = false;
                if (tab.WebViewInstance != null && tab.WebViewInstance.CoreWebView2 != null && !string.IsNullOrEmpty(tab.LastSuspendedUrl))
                {
                    tab.WebViewInstance.Source = new Uri(tab.LastSuspendedUrl);
                    Console.WriteLine($"Pesta√±a reactivada: {tab.Title}");
                }
            }
            SelectedTabItem = tab;
        }


        private void LoadSettings()
        {
            _defaultHomePage = ConfigurationManager.AppSettings[HomePageSettingKey] ?? "https://www.google.com";
            IsAdBlockerEnabled = bool.Parse(ConfigurationManager.AppSettings[AdBlockerSettingKey] ?? "false");
            IsTabSuspensionEnabled = bool.Parse(ConfigurationManager.AppSettings[TabSuspensionSettingKey] ?? "false");

            if (bool.Parse(ConfigurationManager.AppSettings[RestoreSessionSettingKey] ?? "false"))
            {
                RestoreLastSession();
            }
            else
            {
                AddNewTab(_defaultHomePage); // Abrir una nueva pesta√±a si no se restaura la sesi√≥n
            }
        }

        private void SaveSettings()
        {
            Configuration config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
            config.AppSettings.Settings[HomePageSettingKey].Value = _defaultHomePage;
            config.AppSettings.Settings[AdBlockerSettingKey].Value = IsAdBlockerEnabled.ToString();
            config.AppSettings.Settings[TabSuspensionSettingKey].Value = IsTabSuspensionEnabled.ToString();

            // Guardar URLs de la sesi√≥n actual si la restauraci√≥n est√° activada
            if (bool.Parse(ConfigurationManager.AppSettings[RestoreSessionSettingKey] ?? "false"))
            {
                SaveCurrentSession();
            }
            else
            {
                // Limpiar la configuraci√≥n de la sesi√≥n si la restauraci√≥n est√° desactivada
                config.AppSettings.Settings[LastSessionUrlsSettingKey].Value = "";
                config.AppSettings.Settings[LastSessionTabGroupsSettingKey].Value = "";
                config.AppSettings.Settings[LastSelectedTabGroupSettingKey].Value = "";
            }

            config.Save(ConfigurationSaveMode.Modified);
            ConfigurationManager.RefreshSection("appSettings");
        }

        private void SaveCurrentSession()
        {
            Configuration config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);

            // Guardar URLs de todas las pesta√±as abiertas
            var allUrls = TabGroupManager.TabGroups
                                        .SelectMany(g => g.TabsInGroup)
                                        .Select(tab => tab.WebViewInstance?.Source?.ToString())
                                        .Where(url => !string.IsNullOrEmpty(url) && url != "about:blank")
                                        .ToList();
            config.AppSettings.Settings[LastSessionUrlsSettingKey].Value = JsonSerializer.Serialize(allUrls);

            // Guardar el estado de los grupos de pesta√±as
            var groupStates = TabGroupManager.TabGroups.Select(g => new TabGroupState
            {
                GroupId = g.GroupId,
                GroupName = g.GroupName,
                TabUrls = g.TabsInGroup.Select(t => t.WebViewInstance?.Source?.ToString()).Where(url => !string.IsNullOrEmpty(url) && url != "about:blank").ToList(),
                SelectedTabUrl = g.SelectedTabItem?.WebViewInstance?.Source?.ToString()
            }).ToList();
            config.AppSettings.Settings[LastSessionTabGroupsSettingKey].Value = JsonSerializer.Serialize(groupStates);

            // Guardar el ID del grupo de pesta√±as seleccionado
            config.AppSettings.Settings[LastSelectedTabGroupSettingKey].Value = TabGroupManager.SelectedTabGroup?.GroupId ?? "";

            config.Save(ConfigurationSaveMode.Modified);
            ConfigurationManager.RefreshSection("appSettings");
        }


        private async void RestoreLastSession()
        {
            var savedTabGroupsJson = ConfigurationManager.AppSettings[LastSessionTabGroupsSettingKey];
            if (!string.IsNullOrEmpty(savedTabGroupsJson))
            {
                try
                {
                    var groupStates = JsonSerializer.Deserialize<List<TabGroupState>>(savedTabGroupsJson);
                    if (groupStates != null && groupStates.Any())
                    {
                        TabGroupManager.TabGroups.Clear(); // Limpiar grupos por defecto

                        foreach (var groupState in groupStates)
                        {
                            var newGroup = new TabGroup(groupState.GroupId, groupState.GroupName);
                            TabGroupManager.AddGroup(newGroup);

                            foreach (var url in groupState.TabUrls)
                            {
                                if (!string.IsNullOrEmpty(url))
                                {
                                    var newTab = CreateNewTabItem(url);
                                    newGroup.AddTab(newTab);
                                    await newTab.WebViewInstance.EnsureCoreWebView2Async(null);
                                }
                            }

                            // Seleccionar la pesta√±a que estaba seleccionada en este grupo
                            if (!string.IsNullOrEmpty(groupState.SelectedTabUrl))
                            {
                                var selectedTab = newGroup.TabsInGroup.FirstOrDefault(t => t.WebViewInstance?.Source?.ToString() == groupState.SelectedTabUrl);
                                if (selectedTab != null)
                                {
                                    newGroup.SelectedTabItem = selectedTab;
                                }
                            }
                        }

                        // Restaurar el grupo de pesta√±as seleccionado
                        var lastSelectedGroupId = ConfigurationManager.AppSettings[LastSelectedTabGroupSettingKey];
                        var restoredSelectedGroup = TabGroupManager.TabGroups.FirstOrDefault(g => g.GroupId == lastSelectedGroupId);
                        if (restoredSelectedGroup != null)
                        {
                            TabGroupManager.SelectedTabGroup = restoredSelectedGroup;
                            BrowserTabs.ItemsSource = restoredSelectedGroup.TabsInGroup; // Actualizar el ItemsSource
                            SelectedTabItem = restoredSelectedGroup.SelectedTabItem; // Asegurar que la pesta√±a seleccionada se actualice
                        }
                        else
                        {
                            TabGroupManager.SelectedTabGroup = TabGroupManager.GetDefaultGroup();
                            BrowserTabs.ItemsSource = TabGroupManager.GetDefaultGroup().TabsInGroup;
                            SelectedTabItem = TabGroupManager.GetDefaultGroup().TabsInGroup.FirstOrDefault();
                        }
                    }
                    else
                    {
                        AddNewTab(_defaultHomePage); // Si no hay datos de sesi√≥n, abre una nueva pesta√±a
                    }
                }
                catch (JsonException ex)
                {
                    MessageBox.Show($"Error al restaurar la sesi√≥n: {ex.Message}", "Error de Restauraci√≥n", MessageBoxButton.OK, MessageBoxImage.Error);
                    AddNewTab(_defaultHomePage);
                }
            }
            else
            {
                AddNewTab(_defaultHomePage); // Si no hay datos de sesi√≥n, abre una nueva pesta√±a
            }
        }


        private void ApplyAdBlockerSettings()
        {
            foreach (var group in TabGroupManager.TabGroups)
            {
                foreach (var tab in group.TabsInGroup)
                {
                    if (tab.WebViewInstance != null && tab.WebViewInstance.CoreWebView2 != null)
                    {
                        if (IsAdBlockerEnabled)
                        {
                            tab.WebViewInstance.CoreWebView2.SetWebResourceContextFilter(
                                CoreWebView2WebResourceContext.Image, CoreWebView2WebResourceContext.Script,
                                CoreWebView2WebResourceContext.Stylesheet, CoreWebView2WebResourceContext.Media,
                                CoreWebView2WebResourceContext.Font);
                        }
                        else
                        {
                            tab.WebViewInstance.CoreWebView2.ClearWebResourceContextFilter();
                        }
                    }
                }
            }
        }


        private void ApplyTheme()
        {
            // Limpiar los recursos existentes para evitar duplicados si se llama varias veces
            Resources.Remove("BrowserBackgroundColor");
            Resources.Remove("BrowserBackgroundBrush");
            Resources.Remove("BrowserForegroundColor");
            Resources.Remove("BrowserForegroundBrush");

            if (IsGeminiModeActive)
            {
                Resources.Add("BrowserBackgroundColor", (Color)FindResource("GeminiBackgroundColor"));
                Resources.Add("BrowserBackgroundBrush", (SolidColorBrush)FindResource("GeminiBackgroundBrush"));
                Resources.Add("BrowserForegroundColor", (Color)FindResource("GeminiForegroundColor"));
                Resources.Add("BrowserForegroundBrush", (SolidColorBrush)FindResource("GeminiForegroundBrush"));
            }
            else
            {
                Resources.Add("BrowserBackgroundColor", (Color)FindResource("DefaultBrowserBackgroundColor"));
                Resources.Add("BrowserBackgroundBrush", (SolidColorBrush)FindResource("DefaultBrowserBackgroundBrush"));
                Resources.Add("BrowserForegroundColor", (Color)FindResource("DefaultBrowserForegroundColor"));
                Resources.Add("BrowserForegroundBrush", (SolidColorBrush)FindResource("DefaultBrowserForegroundBrush"));
            }
            // Asegurarse de que el color de fondo de la ventana principal se actualice
            MainBorder.Background = (SolidColorBrush)Resources["BrowserBackgroundBrush"];
        }


        private void Window_Loaded(object sender, RoutedEventArgs e)
        {
            // Maximizar la ventana si estaba maximizada en la √∫ltima sesi√≥n
            if (Application.Current.MainWindow != null &&
                (Application.Current.MainWindow.WindowState == WindowState.Maximized ||
                 (Application.Current.MainWindow.ActualWidth == SystemParameters.WorkArea.Width &&
                  Application.Current.MainWindow.ActualHeight == SystemParameters.WorkArea.Height)))
            {
                this.WindowState = WindowState.Maximized;
            }
            else
            {
                // Restaurar el tama√±o y la posici√≥n si se guardaron
                if (double.TryParse(ConfigurationManager.AppSettings["WindowWidth"], out double width))
                {
                    this.Width = Math.Max(width, MIN_WIDTH);
                }
                if (double.TryParse(ConfigurationManager.AppSettings["WindowHeight"], out double height))
                {
                    this.Height = Math.Max(height, MIN_HEIGHT);
                }
                if (double.TryParse(ConfigurationManager.AppSettings["WindowLeft"], out double left))
                {
                    this.Left = left;
                }
                if (double.TryParse(ConfigurationManager.AppSettings["WindowTop"], out double top))
                {
                    this.Top = top;
                }
            }

            // Establecer el TabControl.ItemsSource al grupo por defecto inicialmente
            BrowserTabs.ItemsSource = TabGroupManager.GetDefaultGroup().TabsInGroup;
            SelectedTabItem = TabGroupManager.GetDefaultGroup().TabsInGroup.FirstOrDefault();

            // Configurar el estilo de las cabeceras de las pesta√±as din√°micamente
            BrowserTabs.ItemTemplate = (DataTemplate)this.Resources["TabHeaderTemplate"];

            // A√±adir un listener al evento SourceChanged de cada WebView2 existente
            foreach (var group in TabGroupManager.TabGroups)
            {
                foreach (var tab in group.TabsInGroup)
                {
                    tab.WebViewInstance.SourceChanged += WebView_SourceChanged;
                    tab.WebViewInstance.NavigationCompleted += WebView_NavigationCompleted;
                    tab.WebViewInstance.CoreWebView2InitializationCompleted += WebView_CoreWebView2InitializationCompleted;
                    tab.WebViewInstance.WebMessageReceived += WebView_WebMessageReceived; // Para comunicaci√≥n con JS
                    tab.WebViewInstance.DownloadStarting += WebView_DownloadStarting;
                }
            }

            // Cargar extensiones (si las hay)
            ExtensionManager.LoadExtensions();
            // Asegurarse de que el DataContext del men√∫ de extensiones est√© configurado
            ExtensionsMenuItem.DataContext = ExtensionManager;
        }

        private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)
        {
            // Guardar el estado de la ventana al cerrar
            Configuration config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
            if (this.WindowState == WindowState.Maximized)
            {
                config.AppSettings.Settings["WindowWidth"].Value = this.RestoreBounds.Width.ToString();
                config.AppSettings.Settings["WindowHeight"].Value = this.RestoreBounds.Height.ToString();
                config.AppSettings.Settings["WindowLeft"].Value = this.RestoreBounds.Left.ToString();
                config.AppSettings.Settings["WindowTop"].Value = this.RestoreBounds.Top.ToString();
            }
            else
            {
                config.AppSettings.Settings["WindowWidth"].Value = this.Width.ToString();
                config.AppSettings.Settings["WindowHeight"].Value = this.Height.ToString();
                config.AppSettings.Settings["WindowLeft"].Value = this.Left.ToString();
                config.AppSettings.Settings["WindowTop"].Value = this.Top.ToString();
            }
            config.Save(ConfigurationSaveMode.Modified);
            ConfigurationManager.RefreshSection("appSettings");

            SaveSettings(); // Guardar todas las configuraciones al cerrar

            // Dispose del sintetizador de voz
            _speechSynthesizer?.Dispose();

            // Detener y liberar el temporizador
            _tabSuspensionTimer?.Stop();
            _tabSuspensionTimer?.Dispose();

            // Limpiar los WebView2 al cerrar para liberar recursos
            foreach (var group in TabGroupManager.TabGroups)
            {
                foreach (var tab in group.TabsInGroup)
                {
                    tab.WebViewInstance?.Dispose();
                }
            }
        }

        private void MainWindow_StateChanged(object? sender, EventArgs e)
        {
            // Ajustar el borde para ventanas maximizadas
            if (WindowState == WindowState.Maximized)
            {
                MainBorder.BorderThickness = new Thickness(0);
                MainBorder.CornerRadius = new CornerRadius(0);
            }
            else
            {
                MainBorder.BorderThickness = new Thickness(1);
                MainBorder.CornerRadius = new CornerRadius(10);
            }
        }

        // Para permitir el arrastre de la ventana cuando WindowStyle="None"
        private void Window_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ChangedButton == MouseButton.Left)
            {
                this.DragMove();
            }
        }

        // M√©todos de control de la ventana
        private void MinimizeButton_Click(object sender, RoutedEventArgs e)
        {
            this.WindowState = WindowState.Minimized;
        }

        private void MaximizeRestoreButton_Click(object sender, RoutedEventArgs e)
        {
            if (this.WindowState == WindowState.Maximized)
            {
                this.WindowState = WindowState.Normal;
            }
            else
            {
                this.WindowState = WindowState.Maximized;
            }
        }

        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }

        private TabItemData CreateNewTabItem(string url)
        {
            var webView = new WebView2();
            var newTabItem = new TabItemData(webView)
            {
                Title = "Cargando...",
                Url = url,
                CapturedData = new CapturedPageData { Url = url } // Inicializar CapturedPageData
            };

            webView.Source = new Uri(url);
            webView.CoreWebView2InitializationCompleted += WebView_CoreWebView2InitializationCompleted;
            webView.NavigationCompleted += WebView_NavigationCompleted;
            webView.SourceChanged += WebView_SourceChanged;
            webView.WebMessageReceived += WebView_WebMessageReceived; // Para comunicaci√≥n con JS
            webView.DownloadStarting += WebView_DownloadStarting;
            webView.ContextMenuOpening += WebView_ContextMenuOpening;

            // Establecer el estilo de la barra de desplazamiento
            webView.Loaded += (s, e) =>
            {
                var border = VisualTreeHelper.GetChild(webView, 0) as Border;
                if (border != null)
                {
                    var scrollViewer = border.Child as ScrollViewer;
                    if (scrollViewer != null)
                    {
                        scrollViewer.ScrollBarStyle = (Style)FindResource("CustomScrollBarStyle");
                    }
                }
            };

            return newTabItem;
        }


        private void AddNewTab(string url = "about:blank")
        {
            TabItemData newTabItem = CreateNewTabItem(url);
            TabGroupManager.GetDefaultGroup().AddTab(newTabItem);
            SelectedTabItem = newTabItem;
        }

        private void AddNewTabButton_Click(object sender, RoutedEventArgs e)
        {
            AddNewTab(_defaultHomePage); // Abrir nueva pesta√±a con la p√°gina de inicio
        }

        private void CloseTabButton_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button button && button.Tag is TabItemData tabToClose)
            {
                var currentGroup = TabGroupManager.GetGroupByTab(tabToClose);
                if (currentGroup != null)
                {
                    currentGroup.RemoveTab(tabToClose);
                    tabToClose.WebViewInstance?.Dispose(); // Liberar recursos del WebView2

                    if (currentGroup.TabsInGroup.Count == 0 && TabGroupManager.TabGroups.Count > 1)
                    {
                        TabGroupManager.RemoveGroup(currentGroup);
                    }

                    // Asegurarse de que siempre haya al menos una pesta√±a
                    if (TabGroupManager.TabGroups.All(g => g.TabsInGroup.Count == 0))
                    {
                        AddNewTab(_defaultHomePage);
                    }
                    else if (SelectedTabItem == tabToClose && currentGroup.TabsInGroup.Any())
                    {
                        SelectedTabItem = currentGroup.TabsInGroup.FirstOrDefault();
                    }
                    else if (SelectedTabItem == tabToClose && TabGroupManager.TabGroups.Any())
                    {
                        // Si el grupo actual se vaci√≥, seleccionar el primer tab del primer grupo disponible
                        SelectedTabItem = TabGroupManager.TabGroups.First().TabsInGroup.FirstOrDefault();
                        BrowserTabs.ItemsSource = TabGroupManager.SelectedTabGroup?.TabsInGroup; // Actualizar el ItemsSource
                    }
                }
            }
        }

        private void GoBackCommand_CanExecute(object sender, CanExecuteRoutedEventArgs e)
        {
            e.CanExecute = SelectedTabItem != null && SelectedTabItem.WebViewInstance.CanGoBack;
        }

        private void GoBackCommand_Executed(object sender, ExecutedRoutedEventArgs e)
        {
            SelectedTabItem?.WebViewInstance?.GoBack();
        }

        private void GoForwardCommand_CanExecute(object sender, CanExecuteRoutedEventArgs e)
        {
            e.CanExecute = SelectedTabItem != null && SelectedTabItem.WebViewInstance.CanGoForward;
        }

        private void GoForwardCommand_Executed(object sender, ExecutedRoutedEventArgs e)
        {
            SelectedTabItem?.WebViewInstance?.GoForward();
        }

        private void RefreshCommand_CanExecute(object sender, CanExecuteRoutedEventArgs e)
        {
            e.CanExecute = SelectedTabItem != null;
        }

        private void RefreshCommand_Executed(object sender, ExecutedRoutedEventArgs e)
        {
            SelectedTabItem?.WebViewInstance?.Reload();
        }

        private void HomeCommand_CanExecute(object sender, CanExecuteRoutedEventArgs e)
        {
            e.CanExecute = true; // Siempre se puede ir a la p√°gina de inicio
        }

        private void HomeCommand_Executed(object sender, ExecutedRoutedEventArgs e)
        {
            NavigateToUrl(_defaultHomePage);
        }

        private void SearchCommand_CanExecute(object sender, CanExecuteRoutedEventArgs e)
        {
            e.CanExecute = !string.IsNullOrWhiteSpace(AddressBar.Text);
        }

        private void SearchCommand_Executed(object sender, ExecutedRoutedEventArgs e)
        {
            NavigateToUrl(AddressBar.Text);
        }

        private void AddressBar_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                NavigateToUrl(AddressBar.Text);
            }
        }

        private void NavigateButton_Click(object sender, RoutedEventArgs e)
        {
            NavigateToUrl(AddressBar.Text);
        }

        private void NavigateToUrl(string url)
        {
            if (SelectedTabItem != null && SelectedTabItem.WebViewInstance != null)
            {
                string fullUrl = url;
                if (!url.Contains("://") && !url.StartsWith("file://") && !url.StartsWith("about:"))
                {
                    // Si no tiene esquema, intenta prefijar con "https://" o buscar en Google
                    if (url.Contains(".")) // Probablemente un dominio
                    {
                        fullUrl = "https://" + url;
                    }
                    else // Probablemente un t√©rmino de b√∫squeda
                    {
                        string searchEngineUrl = ConfigurationManager.AppSettings[DefaultSearchEngineSettingKey] ?? "https://www.google.com/search?q=";
                        fullUrl = searchEngineUrl + Uri.EscapeDataString(url);
                    }
                }

                try
                {
                    SelectedTabItem.WebViewInstance.Source = new Uri(fullUrl);
                }
                catch (UriFormatException)
                {
                    MessageBox.Show("URL o t√©rmino de b√∫squeda inv√°lido.", "Error de Navegaci√≥n", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private void WebView_NavigationCompleted(object? sender, CoreWebView2NavigationCompletedEventArgs e)
        {
            var webView = sender as WebView2;
            if (webView != null)
            {
                var tab = TabGroupManager.TabGroups.SelectMany(g => g.TabsInGroup).FirstOrDefault(t => t.WebViewInstance == webView);
                if (tab != null)
                {
                    tab.Url = webView.Source.ToString();
                    AddressBar.Text = tab.Url; // Actualizar la barra de direcciones

                    // Obtener el t√≠tulo y el favicon de la p√°gina
                    UpdateTabTitleAndFavicon(tab, webView);

                    // Desactivar el modo de lectura si no es una p√°gina de lectura
                    if (tab.IsReaderMode)
                    {
                        // Verificar si la p√°gina sigue siendo apta para el modo de lectura
                        // Esto es complejo y podr√≠a requerir volver a analizar el DOM
                        // Por simplicidad, aqu√≠ asumimos que al navegar, el modo de lectura se desactiva
                        tab.IsReaderMode = false;
                    }

                    // Inyectar el script para la extracci√≥n de texto si la extensi√≥n est√° habilitada
                    var textExtractionExtension = ExtensionManager.Extensions.FirstOrDefault(ext => ext.Name == "Text Extractor"); // Usar Name o un Id √∫nico
                    if (textExtractionExtension != null && textExtractionExtension.IsEnabled)
                    {
                        string scriptContent = textExtractionExtension.LoadScriptContent();
                        if (!string.IsNullOrEmpty(scriptContent))
                        {
                            webView.CoreWebView2.ExecuteScriptAsync(scriptContent);
                        }
                    }

                    // Inyectar scripts de las extensiones habilitadas
                    foreach (var extension in ExtensionManager.Extensions)
                    {
                        if (extension.IsEnabled)
                        {
                            string scriptContent = extension.LoadScriptContent();
                            if (!string.IsNullOrEmpty(scriptContent))
                            {
                                webView.CoreWebView2.ExecuteScriptAsync(scriptContent);
                            }
                        }
                    }

                    // Despu√©s de la navegaci√≥n, obtener el texto de la p√°gina y la captura de pantalla para Gemini
                    // No lo hacemos aqu√≠ autom√°ticamente para cada navegaci√≥n, sino cuando el usuario lo pida expl√≠citamente.
                    // Esto se har√° a trav√©s del bot√≥n "Capture Data for Gemini".
                }
            }
        }

        private async void UpdateTabTitleAndFavicon(TabItemData tab, WebView2 webView)
        {
            if (webView.CoreWebView2 != null)
            {
                try
                {
                    // Obtener el t√≠tulo
                    string title = await webView.CoreWebView2.ExecuteScriptAsync("document.title");
                    tab.Title = title.Replace("\"", ""); // Eliminar comillas dobles

                    // Obtener el favicon
                    string getFaviconScript = @"
                        (function() {
                            var faviconLink = document.querySelector('link[rel~=""icon""]');
                            if (faviconLink) {
                                return faviconLink.href;
                            }
                            return null;
                        })();
                    ";
                    string faviconUrlJson = await webView.CoreWebView2.ExecuteScriptAsync(getFaviconScript);
                    string faviconUrl = JsonSerializer.Deserialize<string>(faviconUrlJson) ?? "";

                    if (!string.IsNullOrEmpty(faviconUrl))
                    {
                        // Si la URL del favicon es relativa, hacerla absoluta
                        if (!faviconUrl.Contains("://"))
                        {
                            Uri baseUri = new Uri(webView.Source.ToString());
                            Uri absoluteUri = new Uri(baseUri, faviconUrl);
                            faviconUrl = absoluteUri.ToString();
                        }

                        // Descargar el favicon y convertirlo a Base64
                        try
                        {
                            using (var httpClient = new System.Net.Http.HttpClient())
                            {
                                byte[] faviconBytes = await httpClient.GetByteArrayAsync(faviconUrl);
                                tab.Favicon = new BitmapImage();
                                tab.Favicon.BeginInit();
                                tab.Favicon.StreamSource = new MemoryStream(faviconBytes);
                                tab.Favicon.EndInit();

                                // Guardar el favicon en Base64 para GeminiDataViewerWindow
                                tab.CapturedData.FaviconBase64 = Convert.ToBase64String(faviconBytes);
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error al descargar o procesar el favicon: {ex.Message}");
                            tab.Favicon = null; // O establecer un favicon predeterminado
                            tab.CapturedData.FaviconBase64 = string.Empty;
                        }
                    }
                    else
                    {
                        tab.Favicon = null; // No hay favicon
                        tab.CapturedData.FaviconBase64 = string.Empty;
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error al obtener t√≠tulo o favicon: {ex.Message}");
                    tab.Title = "Error";
                    tab.Favicon = null;
                    tab.CapturedData.FaviconBase64 = string.Empty;
                }
            }
        }


        private void WebView_SourceChanged(object? sender, CoreWebView2SourceChangedEventArgs e)
        {
            var webView = sender as WebView2;
            if (webView != null)
            {
                var tab = TabGroupManager.TabGroups.SelectMany(g => g.TabsInGroup).FirstOrDefault(t => t.WebViewInstance == webView);
                if (tab != null && SelectedTabItem == tab)
                {
                    AddressBar.Text = webView.Source.ToString();
                }
            }
        }

        private async void WebView_CoreWebView2InitializationCompleted(object? sender, CoreWebView2InitializationCompletedEventArgs e)
        {
            var webView = sender as WebView2;
            if (webView != null && webView.CoreWebView2 != null)
            {
                webView.CoreWebView2.Settings.AreDefaultContextMenusEnabled = true;
                webView.CoreWebView2.Settings.AreDevToolsEnabled = false; // Deshabilitar DevTools
                webView.CoreWebView2.Settings.IsStatusBarEnabled = false; // Ocultar barra de estado

                // Aplicar el filtro de ad-blocker si est√° habilitado
                if (IsAdBlockerEnabled)
                {
                    webView.CoreWebView2.SetWebResourceContextFilter(
                        CoreWebView2WebResourceContext.Image, CoreWebView2WebResourceContext.Script,
                        CoreWebView2WebResourceContext.Stylesheet, CoreWebView2WebResourceContext.Media,
                        CoreWebView2WebResourceContext.Font);
                }

                // Inyectar el script de ad-blocker y otros scripts de extensi√≥n aqu√≠ si son de "RunOnDocumentReady"
                foreach (var extension in ExtensionManager.Extensions)
                {
                    if (extension.IsEnabled)
                    {
                        string scriptContent = extension.LoadScriptContent();
                        if (!string.IsNullOrEmpty(scriptContent))
                        {
                            await webView.CoreWebView2.AddScriptToExecuteOnDocumentCreatedAsync(scriptContent);
                        }
                    }
                }
            }
        }

        private void BrowserTabControl_SelectionChanged_Grouped(object sender, SelectionChangedEventArgs e)
        {
            if (BrowserTabs.SelectedItem is TabItemData selectedTab)
            {
                SelectedTabItem = selectedTab;
                AddressBar.Text = selectedTab.Url;
                UpdateNavigationButtons(); // Actualizar el estado de los botones de navegaci√≥n
            }
            else
            {
                // Manejar el caso donde no hay pesta√±a seleccionada (por ejemplo, al cerrar la √∫ltima)
                AddressBar.Text = "";
                UpdateNavigationButtons();
            }
        }

        private void UpdateBrowserControls()
        {
            // Ocultar la barra de b√∫squeda si se cambia de pesta√±a
            IsFindBarVisible = false;
            FindTextBox.Text = "";
            FindResultsTextBlock.Text = "";
            SelectedTabItem?.WebViewInstance?.CoreWebView2?.StopFindInPage(); // Usar operador ?. para evitar NullReferenceException

            // Actualizar botones de navegaci√≥n
            UpdateNavigationButtons();
        }

        private void UpdateNavigationButtons()
        {
            GoBackButton.IsEnabled = SelectedTabItem?.WebViewInstance?.CanGoBack ?? false;
            GoForwardButton.IsEnabled = SelectedTabItem?.WebViewInstance?.CanGoForward ?? false;
        }


        // Funcionalidad de B√∫squeda en P√°gina (Find in Page)
        private void FindButton_Click(object sender, RoutedEventArgs e)
        {
            IsFindBarVisible = true;
            FindTextBox.Focus();
        }

        private void CloseFindBarButton_Click(object sender, RoutedEventArgs e)
        {
            IsFindBarVisible = false;
            FindTextBox.Text = "";
            FindResultsTextBlock.Text = "";
            SelectedTabItem?.WebViewInstance?.CoreWebView2?.StopFindInPage(); // Usar operador ?.
        }

        private void FindTextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            FindInPage(FindTextBox.Text);
        }

        private void FindInPage(string searchText)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null)
            {
                if (!string.IsNullOrEmpty(searchText))
                {
                    SelectedTabItem.WebViewInstance.CoreWebView2.FindInPage(
                        searchText,
                        CoreWebView2FindInPageKind.None,
                        false, // No resaltar todos los resultados
                        (sender, args) =>
                        {
                            // La propiedad 'Is' no existe en CoreWebView2FindInPageCompletedEventArgs.
                            // Deber√≠as usar args.Matches y args.ActiveMatch para actualizar los resultados.
                            FindResultsTextBlock.Text = $"{args.ActiveMatch}/{args.Matches}";
                        }
                    );
                }
                else
                {
                    SelectedTabItem.WebViewInstance.CoreWebView2.StopFindInPage();
                    FindResultsTextBlock.Text = "";
                }
            }
        }

        private void FindNextButton_Click(object sender, RoutedEventArgs e)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null && !string.IsNullOrEmpty(FindTextBox.Text))
            {
                SelectedTabItem.WebViewInstance.CoreWebView2.FindInPage(
                    FindTextBox.Text,
                    CoreWebView2FindInPageKind.Next,
                    false, // No resaltar todos los resultados
                    (sender, args) =>
                    {
                        FindResultsTextBlock.Text = $"{args.ActiveMatch}/{args.Matches}";
                    }
                );
            }
        }

        private void FindPreviousButton_Click(object sender, RoutedEventArgs e)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null && !string.IsNullOrEmpty(FindTextBox.Text))
            {
                SelectedTabItem.WebViewInstance.CoreWebView2.FindInPage(
                    FindTextBox.Text,
                    CoreWebView2FindInPageKind.Previous,
                    false, // No resaltar todos los resultados
                    (sender, args) =>
                    {
                        FindResultsTextBlock.Text = $"{args.ActiveMatch}/{args.Matches}";
                    }
                );
            }
        }

        // Historial de Navegaci√≥n
        private void HistoryButton_Click(object sender, RoutedEventArgs e)
        {
            // Implementaci√≥n de la ventana de historial
            var historyWindow = new HistoryWindow();
            historyWindow.ShowDialog();
        }

        // Favoritos
        private void BookmarksButton_Click(object sender, RoutedEventArgs e)
        {
            // Implementaci√≥n de la ventana de favoritos
            var bookmarksWindow = new BookmarksWindow();
            bookmarksWindow.ShowDialog();
        }

        // Gestor de Contrase√±as
        private void PasswordManagerButton_Click(object sender, RoutedEventArgs e)
        {
            var passwordManagerWindow = new PasswordManagerWindow();
            passwordManagerWindow.ShowDialog();
        }

        // Extractor de Datos
        private void DataExtractionButton_Click(object sender, RoutedEventArgs e)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null)
            {
                var dataExtractionWindow = new DataExtractionWindow(SelectedTabItem.WebViewInstance.CoreWebView2);
                dataExtractionWindow.Show();
            }
            else
            {
                MessageBox.Show("No hay una pesta√±a activa para extraer datos.", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }

        // Bot√≥n de Configuraci√≥n
        private void SettingsButton_Click(object sender, RoutedEventArgs e)
        {
            var settingsWindow = new SettingsWindow();
            settingsWindow.HomePage = _defaultHomePage;
            settingsWindow.IsAdBlockerEnabled = IsAdBlockerEnabled;
            settingsWindow.IsTabSuspensionEnabled = IsTabSuspensionEnabled; // Pasar el valor actual

            if (settingsWindow.ShowDialog() == true)
            {
                _defaultHomePage = settingsWindow.HomePage;
                IsAdBlockerEnabled = settingsWindow.IsAdBlockerEnabled;
                IsTabSuspensionEnabled = settingsWindow.IsTabSuspensionEnabled; // Actualizar con el valor de la ventana de settings
                SaveSettings(); // Guardar las configuraciones actualizadas
            }
        }

        // Bot√≥n PIP
        private void PipButton_Click(object sender, RoutedEventArgs e)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null && !string.IsNullOrEmpty(SelectedTabItem.Url))
            {
                // En un escenario real, necesitar√≠as extraer la URL del video de la p√°gina.
                // Aqu√≠, para la demostraci√≥n, asumiremos que la URL de la pesta√±a es la URL del video.
                // O podr√≠as buscar un elemento <video> en el DOM y obtener su src.
                string videoUrl = SelectedTabItem.Url; // O implementa l√≥gica para encontrar el video real

                try
                {
                    // Puedes pasar el mismo entorno de WebView2 para que compartan datos, cookies, etc.
                    // O crear uno nuevo para aislamiento. Aqu√≠, para simplificar, se crea uno nuevo si no existe.
                    var pipWindow = new PipWindow(videoUrl, SelectedTabItem.WebViewInstance.CoreWebView2.Environment);
                    pipWindow.Show();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Error al abrir la ventana PIP: {ex.Message}", "Error PIP", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            else
            {
                MessageBox.Show("No hay una URL v√°lida para abrir en PIP.", "Error", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }


        // Men√∫ Contextual del WebView2
        private void WebView_ContextMenuOpening(object sender, ContextMenuEventArgs e)
        {
            // Puedes agregar elementos personalizados al men√∫ contextual aqu√≠ si es necesario
            // Por ejemplo, un elemento para "Abrir en PIP" si se hace clic derecho en un video
        }


        // Funcionalidad de "Leer en voz alta"
        private async void ReadAloudButton_Click(object sender, RoutedEventArgs e)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null)
            {
                if (_isReadingAloud)
                {
                    _speechSynthesizer?.SpeakAsyncCancelAll();
                    _isReadingAloud = false;
                    ReadAloudButton.ToolTip = "Leer en voz alta";
                    // Cambiar √≠cono a "pausar" o "detener" si lo tienes
                }
                else
                {
                    try
                    {
                        // Extraer texto de la p√°gina (puedes usar el mismo script que para Gemini)
                        string extractTextScript = @"
                            (function() {
                                var bodyText = document.body.innerText;
                                // Puedes refinar esto para excluir elementos de navegaci√≥n, etc.
                                return bodyText;
                            })();
                        ";
                        string pageTextJson = await SelectedTabItem.WebViewInstance.CoreWebView2.ExecuteScriptAsync(extractTextScript);
                        string pageText = JsonSerializer.Deserialize<string>(pageTextJson) ?? "";

                        if (!string.IsNullOrEmpty(pageText))
                        {
                            _speechSynthesizer?.SpeakAsync(pageText);
                            _isReadingAloud = true;
                            ReadAloudButton.ToolTip = "Detener lectura";
                            // Cambiar √≠cono a "reproducir"
                        }
                        else
                        {
                            MessageBox.Show("No se pudo extraer texto de la p√°gina para leer en voz alta.", "Leer en Voz Alta", MessageBoxButton.OK, MessageBoxImage.Information);
                        }
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show($"Error al leer en voz alta: {ex.Message}", "Error de Lectura", MessageBoxButton.OK, MessageBoxImage.Error);
                    }
                }
            }
        }

        // Modo Lector
        private async void ReaderModeButton_Click(object sender, RoutedEventArgs e)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null)
            {
                try
                {
                    if (SelectedTabItem.IsReaderMode)
                    {
                        // Desactivar el modo lector: recargar la URL original
                        if (!string.IsNullOrEmpty(SelectedTabItem.Url))
                        {
                            SelectedTabItem.WebViewInstance.Source = new Uri(SelectedTabItem.Url);
                        }
                        SelectedTabItem.IsReaderMode = false;
                        ReaderModeButton.ToolTip = "Modo lector";
                    }
                    else
                    {
                        // Activar el modo lector: inyectar CSS y JavaScript para reformatear la p√°gina
                        string readerModeCss = @"
                            body {
                                font-family: 'Georgia', serif;
                                line-height: 1.6;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                                background-color: #f9f9f9;
                                color: #333;
                            }
                            p {
                                margin-bottom: 1em;
                            }
                            img {
                                max-width: 100%;
                                height: auto;
                                display: block;
                                margin: 1em auto;
                            }
                            h1, h2, h3, h4, h5, h6 {
                                font-family: 'Helvetica Neue', sans-serif;
                                color: #1a1a1a;
                                margin-top: 1.5em;
                                margin-bottom: 0.5em;
                            }
                            a {
                                color: #007bff;
                                text-decoration: none;
                            }
                            a:hover {
                                text-decoration: underline;
                            }
                            /* Ocultar elementos irrelevantes */
                            header, footer, nav, aside, .sidebar, .comments, .ads, .related-posts {
                                display: none !important;
                            }
                        ";

                        string readerModeScript = @"
                            (function() {
                                var style = document.createElement('style');
                                style.textContent = `" + readerModeCss.Replace("`", "\\`") + @"`; // Escapar backticks
                                document.head.appendChild(style);

                                // Opcional: Simplificar el DOM para eliminar ruido adicional
                                var elementsToRemove = 'header, footer, nav, aside, .sidebar, .comments, .ads, .related-posts, script, style';
                                document.querySelectorAll(elementsToRemove).forEach(function(el) {
                                    el.parentNode.removeChild(el);
                                });

                                // Centrar el contenido
                                document.body.style.margin = '0 auto';
                                document.body.style.maxWidth = '800px';
                                document.body.style.padding = '20px';
                            })();
                        ";
                        await SelectedTabItem.WebViewInstance.CoreWebView2.ExecuteScriptAsync(readerModeScript);
                        SelectedTabItem.IsReaderMode = true;
                        ReaderModeButton.ToolTip = "Desactivar modo lector";
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Error al cambiar el modo lector: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }


        // Modo Inc√≥gnito (ejemplo - requiere m√°s l√≥gica para ser completo)
        private void IncognitoButton_Click(object sender, RoutedEventArgs e)
        {
            // Para un modo inc√≥gnito real, necesitar√≠as:
            // 1. Crear un nuevo CoreWebView2Environment con un UserDataFolder temporal.
            // 2. Abrir una nueva ventana de navegador o una nueva pesta√±a con este entorno.
            // 3. Asegurarse de que no se guarden historial, cookies, etc. para este entorno.

            // Por ahora, solo abrimos una nueva pesta√±a con un mensaje.
            // (La implementaci√≥n completa de modo inc√≥gnito es compleja y va m√°s all√° del alcance de este ejemplo).
            MessageBox.Show("El modo inc√≥gnito abre una nueva ventana donde la actividad de navegaci√≥n no se guarda en el historial ni en las cookies despu√©s de cerrar la ventana.", "Modo Inc√≥gnito", MessageBoxButton.OK, MessageBoxImage.Information);

            // Ejemplo de c√≥mo podr√≠as abrir una nueva ventana con un entorno diferente:
            // var incognitoEnv = await CoreWebView2Environment.CreateAsync(null, Path.Combine(Path.GetTempPath(), "AuroraIncognito", Guid.NewGuid().ToString()));
            // var incognitoWindow = new MainWindow(incognitoEnv); // Necesitar√≠as un constructor que acepte el entorno
            // incognitoWindow.Show();
        }

        // Men√∫ de Extensiones (manejo de clics)
        private void ExtensionMenuItem_Click(object sender, RoutedEventArgs e)
        {
            if (sender is MenuItem menuItem && menuItem.Tag is CustomExtension extension)
            {
                extension.IsEnabled = !extension.IsEnabled; // Alternar el estado
                                                            // Aplicar/desaplicar extensi√≥n si es necesario (ej: inyectar/eliminar script)
                ApplyExtension(extension);
            }
        }

        private async void ApplyExtension(CustomExtension extension)
        {
            if (SelectedTabItem?.WebViewInstance?.CoreWebView2 != null)
            {
                string scriptContent = extension.LoadScriptContent();
                if (!string.IsNullOrEmpty(scriptContent))
                {
                    if (extension.IsEnabled)
                    {
                        // Inyectar el script en la pesta√±a actual
                        await SelectedTabItem.WebViewInstance.CoreWebView2.ExecuteScriptAsync(scriptContent);
                        // Tambi√©n podr√≠as considerar inyectarlo en todas las pesta√±as existentes o futuras
                    }
                    else
                    {
                        // Para "desaplicar" una extensi√≥n, es m√°s complejo.
                        // A menudo implica recargar la p√°gina o ejecutar un script de "limpieza".
                        // Para este ejemplo, solo avisamos.
                        MessageBox.Show($"La extensi√≥n '{extension.Name}' ha sido {(extension.IsEnabled ? "activada" : "desactivada")}. Puede que necesite recargar la p√°gina para ver los cambios.", "Extensiones", MessageBoxButton.OK, MessageBoxImage.Information);
                    }
                }
            }
        }

        private void ManageExtensionsButton_Click(object sender, RoutedEventArgs e)
        {
            var extensionsWindow = new ExtensionsWindow(ExtensionManager);
            extensionsWindow.ShowDialog();
            // Despu√©s de cerrar la ventana de extensiones, recargar/aplicar configuraciones si es necesario
            // Por ejemplo, si se activaron o desactivaron extensiones.
        }

        // Manejo de mensajes desde JavaScript (para extensiones, extracci√≥n de datos, etc.)
        private async void WebView_WebMessageReceived(object? sender, CoreWebView2WebMessageReceivedEventArgs e)
        {
            var webView = sender as WebView2;
            if (webView == null) return;

            string message = e.WebMessageAsJson;

            // Procesar mensajes JSON espec√≠ficos
            try
            {
                using (JsonDocument doc = JsonDocument.Parse(message))
                {
                    if (doc.RootElement.TryGetProperty("type", out JsonElement typeElement))
                    {
                        string messageType = typeElement.GetString() ?? "";

                        switch (messageType)
                        {
                            case "extractedText":
                                if (doc.RootElement.TryGetProperty("text", out JsonElement textElement))
                                {
                                    string extractedText = textElement.GetString() ?? "";
                                    Console.WriteLine($"Texto Extra√≠do: {extractedText.Substring(0, Math.Min(extractedText.Length, 200))}..."); // Log para depuraci√≥n

                                    var tab = TabGroupManager.TabGroups.SelectMany(g => g.TabsInGroup).FirstOrDefault(t => t.WebViewInstance == webView);
                                    if (tab != null)
                                    {
                                        tab.CapturedData.ExtractedText = extractedText;
                                    }
                                }
                                break;
                            case "passwordDetected":
                                if (doc.RootElement.TryGetProperty("url", out JsonElement urlElement) &&
                                    doc.RootElement.TryGetProperty("username", out JsonElement usernameElement) &&
                                    doc.RootElement.TryGetProperty("password", out JsonElement passwordElement))
                                {
                                    string url = urlElement.GetString() ?? "";
                                    string username = usernameElement.GetString() ?? "";
                                    string password = passwordElement.GetString() ?? "";

                                    // Preguntar al usuario si desea guardar la contrase√±a
                                    var result = MessageBox.Show($"¬øDeseas guardar la contrase√±a para {username} en {url}?", "Guardar Contrase√±a", MessageBoxButton.YesNo, MessageBoxImage.Question);
                                    if (result == MessageBoxResult.Yes)
                                    {
                                        PasswordManager.SavePassword(url, username, password);
                                        MessageBox.Show("Contrase√±a guardada exitosamente.", "√âxito", MessageBoxButton.OK, MessageBoxImage.Information);
                                    }
                                }
                                break;
                                // Otros tipos de mensajes si se implementan m√°s extensiones
                        }
                    }
                }
            }
            catch (JsonException ex)
            {
                Console.WriteLine($"Error al parsear mensaje de WebView2 como JSON: {ex.Message}");
                // Si no es JSON, podr√≠a ser un mensaje de depuraci√≥n simple
                Console.WriteLine($"Mensaje recibido de WebView2: {message}");
            }
        }


        // Manejo de descargas
        private void WebView_DownloadStarting(object? sender, CoreWebView2DownloadStartingEventArgs e)
        {
            // Prevenir la descarga autom√°tica y mostrar una barra de progreso
            e.Cancel = true;

            // Obtener el nombre de archivo sugerido
            string suggestedFileName = Path.GetFileName(e.ResultFilePath);

            // Abrir un SaveFileDialog para que el usuario elija d√≥nde guardar
            Microsoft.Win32.SaveFileDialog saveFileDialog = new Microsoft.Win32.SaveFileDialog();
            saveFileDialog.FileName = suggestedFileName;
            saveFileDialog.Title = "Guardar archivo";

            if (saveFileDialog.ShowDialog() == true)
            {
                e.ResultFilePath = saveFileDialog.FileName;
                e.Cancel = false; // Permitir que la descarga contin√∫e al path elegido

                DownloadProgressBarVisibility = Visibility.Visible;
                DownloadProgress = 0;

                e.DownloadOperation.BytesReceivedChanged += (s, args) =>
                {
                    Dispatcher.Invoke(() =>
                    {
                        if (e.DownloadOperation.TotalBytesToReceive > 0)
                        {
                            DownloadProgress = (double)e.DownloadOperation.BytesReceived * 100 / e.DownloadOperation.TotalBytesToReceive;
                        }
                    });
                };

                e.DownloadOperation.StateChanged += (s, args) =>
                {
                    Dispatcher.Invoke(() =>
                    {
                        switch (e.DownloadOperation.State)
                        {
                            case CoreWebView2DownloadState.Completed:
                                MessageBox.Show($"Descarga completada: {e.ResultFilePath}", "Descarga", MessageBoxButton.OK, MessageBoxImage.Information);
                                DownloadProgressBarVisibility = Visibility.Collapsed;
                                break;
                            case CoreWebView2DownloadState.Interrupted:
                                MessageBox.Show($"Descarga interrumpida: {e.DownloadOperation.InterruptReason}", "Descarga Fallida", MessageBoxButton.OK, MessageBoxImage.Error);
                                DownloadProgressBarVisibility = Visibility.Collapsed;
                                break;
                        }
                    });
                };
            }
            else
            {
                // El usuario cancel√≥ la descarga
                e.Cancel = true;
            }
        }

        // Comando para a√±adir un nuevo grupo de pesta√±as
        public ICommand AddTabGroupCommand => new RelayCommand(_ => AddNewTabGroup());

        private void AddNewTabGroup()
        {
            var newGroup = new TabGroup($"Grupo {TabGroupManager.TabGroups.Count + 1}");
            TabGroupManager.AddGroup(newGroup);
            TabGroupManager.SelectedTabGroup = newGroup;
            AddNewTab(_defaultHomePage); // A√±adir una pesta√±a por defecto al nuevo grupo
            BrowserTabs.ItemsSource = newGroup.TabsInGroup; // Actualizar el ItemsSource del TabControl
        }

        // Comando para seleccionar un grupo de pesta√±as (desde el men√∫ de grupos)
        public ICommand SelectTabGroupCommand => new RelayCommand(parameter =>
        {
            if (parameter is TabGroup selectedGroup)
            {
                TabGroupManager.SelectedTabGroup = selectedGroup;
                BrowserTabs.ItemsSource = selectedGroup.TabsInGroup; // Actualizar el ItemsSource del TabControl
                SelectedTabItem = selectedGroup.TabsInGroup.FirstOrDefault(); // Seleccionar la primera pesta√±a del grupo
            }
        });

        // Evento para arrastrar la ventana sin bordes
        [DllImport("user32.dll")]
        public static extern IntPtr SendMessage(IntPtr hWnd, int wMsg, int wParam, int lParam);
        private const int WM_NCLBUTTONDOWN = 0xA1;
        private const int HT_CAPTION = 0x2;

        private void MainWindow_SourceInitialized(object sender, EventArgs e)
        {
            HwndSource? source = PresentationSource.FromVisual(this) as HwndSource;
            if (source != null)
            {
                source.AddHook(WndProc);
            }
        }

        private IntPtr WndProc(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)
        {
            switch (msg)
            {
                case WM_NCLBUTTONDOWN:
                    if (wParam.ToInt32() == HT_CAPTION)
                    {
                        // Permitir arrastrar la ventana incluso si el mouse est√° sobre controles
                        // No necesitas llamar a DragMove() aqu√≠ si usas SendMessage
                        handled = true; // Marca el evento como manejado para evitar el procesamiento por defecto
                    }
                    break;
            }
            return IntPtr.Zero;
        }

        // Funcionalidad de IA/Gemini
        private async void GeminiButton_Click(object sender, RoutedEventArgs e)
        {
            // 1. Recolectar datos de las pesta√±as activas (o seleccionadas)
            // Por simplicidad, tomaremos los datos de la pesta√±a actualmente seleccionada.
            // Para m√∫ltiples pesta√±as, necesitar√≠as un mecanismo de selecci√≥n (ej. checkboxes en cada tab).
            var capturedDataList = new ObservableCollection<CapturedPageData>();

            if (SelectedTabItem != null)
            {
                // Asegurarse de que el CoreWebView2 est√© inicializado
                if (SelectedTabItem.WebViewInstance.CoreWebView2 == null)
                {
                    await SelectedTabItem.WebViewInstance.EnsureCoreWebView2Async(null);
                }

                // Intentar capturar la informaci√≥n
                try
                {
                    // Obtener texto de la p√°gina
                    string extractedText = await GetPageText(SelectedTabItem.WebViewInstance.CoreWebView2);
                    SelectedTabItem.CapturedData.ExtractedText = extractedText;

                    // Capturar captura de pantalla
                    string screenshotBase64 = await CaptureScreenshotAsync(SelectedTabItem.WebViewInstance);
                    SelectedTabItem.CapturedData.ScreenshotBase64 = screenshotBase64;

                    // El favicon ya se deber√≠a haber capturado en WebView_NavigationCompleted
                    // Si no, puedes intentar obtenerlo aqu√≠ tambi√©n
                    if (string.IsNullOrEmpty(SelectedTabItem.CapturedData.FaviconBase64) && SelectedTabItem.Favicon != null)
                    {
                        SelectedTabItem.CapturedData.FaviconBase64 = ConvertBitmapImageToBase64(SelectedTabItem.Favicon);
                    }


                    // Asignar los valores a la instancia de CapturedPageData de la pesta√±a
                    SelectedTabItem.CapturedData.Url = SelectedTabItem.Url;
                    SelectedTabItem.CapturedData.Title = SelectedTabItem.Title;

                    // Agregar la pesta√±a actual a la lista de datos capturados
                    capturedDataList.Add(SelectedTabItem.CapturedData);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Error al capturar datos de la p√°gina para Gemini: {ex.Message}", "Error de Captura", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
                }
            }
            else
            {
                MessageBox.Show("No hay una pesta√±a activa para enviar a Gemini.", "Advertencia", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            // 2. Mostrar la ventana GeminiDataViewerWindow con los datos capturados
            var geminiViewerWindow = new GeminiDataViewerWindow(capturedDataList);
            // Establecer el propietario para centrarla respecto a MainWindow
            geminiViewerWindow.Owner = this;

            if (geminiViewerWindow.ShowDialog() == true)
            {
                // El usuario hizo clic en "Enviar a Gemini"
                string userQuestion = geminiViewerWindow.UserQuestion;

                // Aqu√≠ es donde se har√≠a la llamada a la API de Gemini
                // Por ejemplo: await CallGeminiAPI(userQuestion, capturedDataList);
                MessageBox.Show($"Datos enviados a Gemini con la pregunta: '{userQuestion}'", "Gemini", MessageBoxButton.OK, MessageBoxImage.Information);
                IsGeminiModeActive = true; // Activar el modo Gemini al enviar la pregunta
            }
            else
            {
                // El usuario hizo clic en "Cancelar"
                MessageBox.Show("Env√≠o a Gemini cancelado.", "Gemini", MessageBoxButton.OK, MessageBoxImage.Information);
                IsGeminiModeActive = false; // Desactivar el modo Gemini
            }
        }


        private async Task<string> GetPageText(CoreWebView2 webView)
        {
            if (webView == null) return string.Empty;

            try
            {
                // Este script intenta obtener el texto legible principal de la p√°gina.
                // Puede ser necesario ajustarlo para diferentes estructuras de sitios web.
                string script = @"
                    (function() {
                        // Prioriza elementos de contenido com√∫n
                        var selectors = ['article', 'main', 'body'];
                        for (var i = 0; i < selectors.length; i++) {
                            var element = document.querySelector(selectors[i]);
                            if (element && element.innerText) {
                                return element.innerText;
                            }
                        }
                        return document.body.innerText; // Fallback al texto completo del body
                    })();
                ";
                string pageTextJson = await webView.ExecuteScriptAsync(script);
                return JsonSerializer.Deserialize<string>(pageTextJson) ?? string.Empty;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al extraer texto de la p√°gina: {ex.Message}");
                return string.Empty;
            }
        }

        private async Task<string> CaptureScreenshotAsync(WebView2 webView)
        {
            if (webView.CoreWebView2 == null)
            {
                await webView.EnsureCoreWebView2Async(null); // Aseg√∫rate de que CoreWebView2 est√© inicializado
            }

            try
            {
                // Get the scrollable dimensions of the page
                var contentSizeJson = await webView.CoreWebView2.ExecuteScriptAsync(
                    "(function() { " +
                    "  var body = document.body, html = document.documentElement;" +
                    "  var height = Math.max( body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight );" +
                    "  var width = Math.max( body.scrollWidth, body.offsetWidth, html.clientWidth, html.scrollWidth, html.offsetWidth );" +
                    "  return { width: width, height: height };" +
                    "})()"
                );

                using (JsonDocument doc = JsonDocument.Parse(contentSizeJson))
                {
                    int contentWidth = doc.RootElement.GetProperty("width").GetInt32();
                    int contentHeight = doc.RootElement.GetProperty("height").GetInt32();

                    // Clamp to reasonable maximums to prevent out-of-memory issues for very large pages
                    const int MAX_DIMENSION = 8000; // Example limit, adjust as needed
                    contentWidth = Math.Min(contentWidth, MAX_DIMENSION);
                    contentHeight = Math.Min(contentHeight, MAX_DIMENSION);

                    // Save original WebView2 size
                    double originalWidth = webView.Width;
                    double originalHeight = webView.Height;

                    // Temporarily resize WebView2 to capture full content
                    // Ensure the WebView2 is part of the visual tree and laid out
                    // This might require running on the UI thread and ensuring layout passes
                    Dispatcher.Invoke(() =>
                    {
                        webView.Width = contentWidth;
                        webView.Height = contentHeight;
                        webView.Measure(new Size(contentWidth, contentHeight));
                        webView.Arrange(new Rect(0, 0, contentWidth, contentHeight));
                    });

                    // Wait for layout to update
                    await Task.Delay(50); // Small delay to allow layout to settle

                    using (MemoryStream stream = new MemoryStream())
                    {
                        // Capture the screenshot
                        await webView.CoreWebView2.CapturePreviewAsync(CoreWebView2CapturePreviewImageFormat.Png, stream);

                        // Restore original WebView2 size
                        Dispatcher.Invoke(() =>
                        {
                            webView.Width = originalWidth;
                            webView.Height = originalHeight;
                            webView.Measure(new Size(originalWidth, originalHeight));
                            webView.Arrange(new Rect(0, 0, originalWidth, originalHeight));
                        });

                        byte[] imageBytes = stream.ToArray();
                        return "data:image/png;base64," + Convert.ToBase64String(imageBytes);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al capturar captura de pantalla: {ex.Message}");
                // Return empty string or a placeholder Base64 image
                return string.Empty;
            }
        }


        // Helper para convertir BitmapImage a Base64 (√∫til para favicon si no viene directamente como bytes)
        private string ConvertBitmapImageToBase64(BitmapImage bitmapImage)
        {
            if (bitmapImage == null) return string.Empty;

            try
            {
                MemoryStream stream = new MemoryStream();
                PngBitmapEncoder encoder = new PngBitmapEncoder();
                encoder.Frames.Add(BitmapFrame.Create(bitmapImage));
                encoder.Save(stream);
                byte[] bytes = stream.ToArray();
                return Convert.ToBase64String(bytes);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al convertir BitmapImage a Base64: {ex.Message}");
                return string.Empty;
            }
        }

        private void SaveBase64ImageAsPng(string base64String, string filePath)
        {
            if (string.IsNullOrEmpty(base64String)) return;

            try
            {
                byte[] imageBytes = Convert.FromBase64String(base64String.Replace("data:image/png;base64,", "")); // Quitar el prefijo si est√° presente
                File.WriteAllBytes(filePath, imageBytes);
                MessageBox.Show($"Captura de pantalla guardada en: {filePath}", "Captura Guardada", MessageBoxButton.OK, MessageBoxImage.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al guardar la captura de pantalla: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }


        // ... El resto de tu c√≥digo igual ...
    }

    public class RelayCommand : ICommand
    {
        private readonly Action<object?> _execute;
        private readonly Predicate<object?>? _canExecute;

        public event EventHandler? CanExecuteChanged
        {
            add { CommandManager.RequerySuggested += value; }
            remove { CommandManager.RequerySuggested -= value; }
        }

        public RelayCommand(Action<object?> execute, Predicate<object?>? canExecute = null)
        {
            _execute = execute ?? throw new ArgumentNullException(nameof(execute));
            _canExecute = canExecute;
        }

        public bool CanExecute(object? parameter)
        {
            return _canExecute == null || _canExecute(parameter);
        }

        public void Execute(object? parameter)
        {
            _execute(parameter);
        }
    }

    public enum ToolbarPosition
    {
        Top,
        Bottom,
        Left,
        Right
    }

    // Clase auxiliar para los datos capturados para Gemini
    public class CapturedPageData : INotifyPropertyChanged
    {
        public string Url { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string ExtractedText { get; set; } = string.Empty;
        public string ScreenshotBase64 { get; set; } = string.Empty; // Base64 de la imagen
        public string FaviconBase64 { get; set; } = string.Empty;   // Base64 del favicon

        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

    // Clases para la serializaci√≥n del estado de la sesi√≥n
    public class TabGroupState
    {
        public string GroupId { get; set; } = Guid.NewGuid().ToString();
        public string GroupName { get; set; } = "Default Group";
        public List<string?> TabUrls { get; set; } = new List<string?>();
        public string? SelectedTabUrl { get; set; }
    }

    // Clase para representar los datos de una pesta√±a en la UI
    public class TabItemData : INotifyPropertyChanged
    {
        private string _title = "Nueva Pesta√±a";
        public string Title
        {
            get => _title;
            set
            {
                if (_title != value)
                {
                    _title = value;
                    OnPropertyChanged(nameof(Title));
                }
            }
        }

        private string _url = "about:blank";
        public string Url
        {
            get => _url;
            set
            {
                if (_url != value)
                {
                    _url = value;
                    OnPropertyChanged(nameof(Url));
                }
            }
        }

        private BitmapImage? _favicon;
        public BitmapImage? Favicon
        {
            get => _favicon;
            set
            {
                if (_favicon != value)
                {
                    _favicon = value;
                    OnPropertyChanged(nameof(Favicon));
                }
            }
        }

        private bool _isLoading;
        public bool IsLoading
        {
            get => _isLoading;
            set
            {
                if (_isLoading != value)
                {
                    _isLoading = value;
                    OnPropertyChanged(nameof(IsLoading));
                }
            }
        }

        private bool _isReaderMode;
        public bool IsReaderMode
        {
            get => _isReaderMode;
            set
            {
                if (_isReaderMode != value)
                {
                    _isReaderMode = value;
                    OnPropertyChanged(nameof(IsReaderMode));
                }
            }
        }

        private bool _isSuspended;
        public bool IsSuspended
        {
            get => _isSuspended;
            set
            {
                if (_isSuspended != value)
                {
                    _isSuspended = value;
                    OnPropertyChanged(nameof(IsSuspended));
                }
            }
        }

        public string? LastSuspendedUrl { get; set; } // Para guardar la URL al suspender

        public WebView2 WebViewInstance { get; }

        public CapturedPageData CapturedData { get; set; } // Datos para Gemini

        public TabItemData(WebView2 webView)
        {
            WebViewInstance = webView;
            CapturedData = new CapturedPageData(); // Inicializar los datos capturados
        }

        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

    // Clase para gestionar grupos de pesta√±as
    public class TabGroup : INotifyPropertyChanged
    {
        public string GroupId { get; }
        private string _groupName;
        public string GroupName
        {
            get => _groupName;
            set
            {
                if (_groupName != value)
                {
                    _groupName = value;
                    OnPropertyChanged(nameof(GroupName));
                }
            }
        }

        public ObservableCollection<TabItemData> TabsInGroup { get; } = new ObservableCollection<TabItemData>();

        private TabItemData? _selectedTabItem;
        public TabItemData? SelectedTabItem
        {
            get => _selectedTabItem;
            set
            {
                if (_selectedTabItem != value)
                {
                    _selectedTabItem = value;
                    OnPropertyChanged(nameof(SelectedTabItem));
                }
            }
        }

        public TabGroup(string name)
        {
            GroupId = Guid.NewGuid().ToString();
            _groupName = name;
        }

        public TabGroup(string id, string name) // Constructor para restauraci√≥n
        {
            GroupId = id;
            _groupName = name;
        }

        public void AddTab(TabItemData tab)
        {
            TabsInGroup.Add(tab);
            if (SelectedTabItem == null)
            {
                SelectedTabItem = tab;
            }
            OnPropertyChanged(nameof(TabsInGroup));
        }

        public void RemoveTab(TabItemData tab)
        {
            TabsInGroup.Remove(tab);
            if (SelectedTabItem == tab)
            {
                SelectedTabItem = TabsInGroup.FirstOrDefault();
            }
            OnPropertyChanged(nameof(TabsInGroup));
        }

        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

    // Clase para gestionar todos los grupos de pesta√±as
    public class TabGroupManager : INotifyPropertyChanged
    {
        public ObservableCollection<TabGroup> TabGroups { get; } = new ObservableCollection<TabGroup>();

        private TabGroup? _selectedTabGroup;
        public TabGroup? SelectedTabGroup
        {
            get => _selectedTabGroup;
            set
            {
                if (_selectedTabGroup != value)
                {
                    _selectedTabGroup = value;
                    OnPropertyChanged(nameof(SelectedTabGroup));
                }
            }
        }

        public TabGroupManager()
        {
            // Asegurarse de que siempre haya al menos un grupo por defecto
            if (!TabGroups.Any())
            {
                AddGroup(new TabGroup("Default Group"));
            }
            SelectedTabGroup = TabGroups.FirstOrDefault();
        }

        public void AddGroup(TabGroup group)
        {
            TabGroups.Add(group);
            OnPropertyChanged(nameof(TabGroups));
        }

        public void RemoveGroup(TabGroup group)
        {
            TabGroups.Remove(group);
            if (SelectedTabGroup == group)
            {
                SelectedTabGroup = TabGroups.FirstOrDefault();
            }
            OnPropertyChanged(nameof(TabGroups));
        }

        public TabGroup GetDefaultGroup()
        {
            return TabGroups.FirstOrDefault(g => g.GroupName == "Default Group") ?? CreateNewDefaultGroup();
        }

        private TabGroup CreateNewDefaultGroup()
        {
            var defaultGroup = new TabGroup("Default Group");
            TabGroups.Insert(0, defaultGroup); // Asegura que el grupo por defecto est√© al principio
            SelectedTabGroup = defaultGroup;
            return defaultGroup;
        }

        public TabGroup? GetGroupByTab(TabItemData tab)
        {
            return TabGroups.FirstOrDefault(g => g.TabsInGroup.Contains(tab));
        }

        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

    // Clase para gestionar extensiones (asumiendo que CustomExtension ya existe)
    public class ExtensionManager : INotifyPropertyChanged
    {
        public ObservableCollection<CustomExtension> Extensions { get; set; } = new ObservableCollection<CustomExtension>();

        public ExtensionManager()
        {
            LoadExtensions();
        }

        public void LoadExtensions()
        {
            // Limpiar las extensiones existentes antes de cargar nuevas
            Extensions.Clear();

            // Ejemplo de carga de extensiones (puedes leerlas desde un archivo JSON o una base de datos)
            // Aseg√∫rate de que los archivos JS de las extensiones existan en el directorio de salida
            Extensions.Add(new CustomExtension("text_extraction_extension", "Text Extractor", "Extrae el texto principal de la p√°gina.", Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "TextExtractor.js")));
            Extensions.Add(new CustomExtension("ad_blocker_extension", "Ad Blocker", "Bloquea anuncios y rastreadores.", Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "AdBlocker.js")));
            // Puedes a√±adir m√°s extensiones aqu√≠
        }

        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

    // Aseg√∫rate de que esta clase CustomExtension est√© definida en CustomExtension.cs o aqu√≠ si es una clase anidada
    // Si ya la tienes en CustomExtension.cs, no la dupliques aqu√≠.
    public class CustomExtension : INotifyPropertyChanged
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public string ScriptPath { get; set; }

        private bool _isEnabled;
        public bool IsEnabled
        {
            get => _isEnabled;
            set
            {
                if (_isEnabled != value)
                {
                    _isEnabled = value;
                    OnPropertyChanged(nameof(IsEnabled));
                }
            }
        }

        public CustomExtension(string id, string name, string description, string scriptPath)
        {
            Id = id;
            Name = name;
            Description = description;
            ScriptPath = scriptPath;
            IsEnabled = false; // Por defecto deshabilitada
        }

        public event PropertyChangedEventHandler? PropertyChanged;

        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }

        public string LoadScriptContent()
        {
            try
            {
                if (File.Exists(ScriptPath))
                {
                    return File.ReadAllText(ScriptPath);
                }
                return string.Empty;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al cargar el script de la extensi√≥n '{Name}': {ex.Message}");
                return string.Empty;
            }
        }
    }
}
